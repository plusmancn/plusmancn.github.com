---
title: 'ã€Šä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªå¤šç«¯ IMã€‹è´°ï¼šé¡µé¢å¯¼èˆªæ¨¡å¼è®¾è®¡- Navigator å¯¼èˆª'
date: '2017-02-24 00:18:32'
tags:
- 'ä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªå¤šç«¯ IM'
- 'react'
- 'react-native'
---

> å…·ä½“å®ç°å‚ç…§ï¼š[UiLibrary/Navigator](https://github.com/plusmancn/im-client/tree/master/UiLibrary/Navigator)

**æ ‡ç¤ºå›¾**  
<img src="../images/im-client-Navigator.png" height="500"/>

ä¸‹é¢è®²è®²å®ç°è¿‡ç¨‹ä¸­æ€è€ƒè¿‡çš„å‡ ä¸ªé—®é¢˜
## è·¯ç”±æ¨¡å¼
**Q: æ¯ä¸ªè§†å›¾æ˜¯å¦éœ€è¦åƒ Web ä¸€æ ·æœ‰ä¸€ä¸ªè·¯ç”±è¡¨ï¼Ÿ**  
è¿™æ˜¯ä»ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯çš„ä¸€ä¸ªè€ƒè™‘ã€‚è§‚å¯Ÿä¼ ç»Ÿçš„ `Web` ç½‘é¡µï¼Œå¾ˆå°‘æœ‰çœŸæ­£æ„ä¹‰ä¸Šçš„è¿”å›æ¦‚å¿µï¼Œå¤§æ¦‚æ˜¯å› ä¸ºåœ¨ `PC` æ—¶ä»£ï¼Œå±å¹•è¶³å¤Ÿå¤§ï¼Œèƒ½å¤Ÿå®¹çº³è¶³å¤Ÿå¤šçš„å¯¼èˆªä¿¡æ¯ï¼Œç”¨æˆ·åŸºæœ¬éƒ½æ˜¯ç‚¹å“ªè¿›å“ªï¼Œå¯¼è‡´ç”¨æˆ·çš„æµè§ˆè½¨è¿¹æ²¡æœ‰ä¸€ä¸ªç¨³å®šçš„è·¯å¾„ï¼Œ æ‰€ä»¥å¼€å‘å»å…³å¿ƒä¸Šä¸€é¡µæ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Œä¹Ÿä¾¿æ²¡æœ‰äº†ä»€ä¹ˆæ„ä¹‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰ä¸€ä¸ªæ¶µç›–æ‰€æœ‰é¡µé¢çš„è·¯ç”±è¡¨ï¼Œèƒ½å¤Ÿå¿«é€Ÿçš„åœ¨é¡µé¢ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œèƒ½å¤Ÿæå¤§æå‡å¼€å‘æ•ˆç‡ï¼Œç®€åŒ–å¼€å‘æµç¨‹ã€‚  
å›åˆ°ç§»åŠ¨ç«¯ `App` çš„å¯¼èˆªæ¨¡å¼ï¼Œå®ƒç±»ä¼¼ `æ ‘çŠ¶ç»“æ„`ï¼Œä¸€ä¸ªåŠŸèƒ½çº¿ç±»ä¼¼ä¸€ä¸ªæ ‘æï¼Œåˆ‡æ¢åˆ°ä¸€ä¸ªåŠŸèƒ½éœ€è¦å…ˆå›åˆ°ä¸»å¹²ï¼Œå†è¿›å…¥åˆ°å¦ä¸€ä¸ªæ ‘æï¼Œä¸ä¼šçºµæ¨ªäº¤é”™ã€‚
è¿™é‡Œæœ‰ä¸€ä¸ªä½¿ç”¨ç»†èŠ‚ï¼Œåœ¨ `App` ä¸­ï¼Œä½ è¿”å›ä¸Šä¸€ä¸ªé¡µé¢çš„æ—¶å€™ï¼Œä¸Šä¸ªé¡µé¢çš„çŠ¶æ€æ˜¯è¢«ä¿ç•™ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç‰¹æ€§ï¼Œåº”ç”¨ä¼šä¿ç•™ä¸€ä¸ªå¯¼èˆªæ ˆï¼Œå¯¼èˆªæ ˆçš„å¤§å°å¤šå°‘ä¼šå½±å“åˆ°åº”ç”¨çš„æ€§èƒ½ï¼Œè¿™ä¹Ÿä¾§é¢å¯¼è‡´ `App` çš„å¯¼èˆªä¸èƒ½æ— é™å»¶ä¼¸ã€‚  
`rn` ç”Ÿæ¥è¿˜æ˜¯ä¸ºäº†åšç§»åŠ¨ç«¯ `App` çš„ï¼Œè¿˜æ˜¯è¦éµå¾ªç§»åŠ¨ç«¯ç”¨æˆ·ä¹ æƒ¯ï¼Œååº”åˆ°æŠ€æœ¯å®ç°ä¸Šï¼Œä¸€ä¸ªå…¨å±€çš„è·¯ç”±è¡¨å¹¶æ²¡æœ‰å¾ˆå¤§æ„ä¹‰ï¼Œæ—¢ç„¶æ˜¯å¯¼èˆªæ ˆï¼Œé‚£ä¹ˆ `push/pop` è£…å¸è§†å›¾ï¼Œä¼šæ›´åŠ å¥‘åˆã€‚

## TabBar å’Œ Navigator çš„å…³ç³»
`TabBar` æ˜¯ `Navigator` çš„ç¬¬ä¸€ä¸ªè·¯ç”±ï¼Œä½äºæ ˆåº•ï¼Œåªè¦å¯¼èˆªæ ˆåœ¨ï¼Œé‚£ä¹ˆ `TabBar` å°±æ°¸è¿œä¸ä¼šè¢«é”€æ¯ï¼Œå°±å¯ä»¥ä¿ç•™å„ç§ç»„ä»¶çŠ¶æ€ï¼Œæ¯”å¦‚æ»‘åŠ¨ä½ç½®ã€è¾“å…¥çŠ¶æ€ã€‚  
å¯¹äº `Navigator` æ¥è¯´ï¼Œä¸€ä¸ª `TabBar` å°±æ˜¯ç¬¬ä¸€ä¸ª `Main Scene` ç½¢äº†ï¼Œå’Œå…¶ä»– `Main Scene` è§†å›¾æ²¡æœ‰åŒºåˆ«ã€‚  
`TabBar` ç”±äºæœ¬èº«åˆå®ç°äº†å¤šä¸ªæ¨ªå‘çš„å¯¼èˆªï¼Œè‡ªå¸¦ç¼“å­˜æœºåˆ¶ã€‚

åŸºäºæ­¤ï¼Œä¸€ä¸ªç»å…¸çš„ `TabBar` + `Navigator` çš„å¯¼èˆªæ¨¡å¼å°±å‡ºæ¥äº†ã€‚  

## route é…ç½®ä¸Šæ”¹æ”¾å“ªäº›å±æ€§
`NavigationCardStack` æŠŠå¯¼èˆªæ ˆçš„æ•°æ®ç»“æ„å¼€æ”¾ç»™äº†å¼€å‘è€…ï¼Œé€šè¿‡æ”¹å˜å¯¼èˆªæ ˆï¼Œè¿›è€Œè§¦å‘è§†å›¾å˜æ›´ï¼ŒåŸºç¡€å®šä¹‰å¦‚ä¸‹ï¼š
```javascript
{
    index: 0, // ä»£è¡¨å½“å‰çš„æ˜¾ç¤ºçš„æ˜¯å“ªä¸ªè·¯ç”±ã€‚
    // è·¯ç”±è§†å›¾çš„é…ç½®ä¿¡æ¯
    routes: [
        {
            key: '0', // è·¯ç”±å”¯ä¸€é”®å€¼
            title: '' // å¦‚æœè‡ªå®šä¹‰ NavigationHeader çš„ renderTitleComponent å±æ€§ï¼Œ
            // é»˜è®¤æ§ä»¶ä¼šå»å– title çš„å±æ€§å€¼
        }
    ]
}
```
è‡ªå®šä¹‰å¯¼èˆªç»„ä»¶çš„è®¾è®¡ä¸­ï¼Œåœ¨æ¯ä¸ª `Main Scene` å†…éƒ¨çš„ç»„ä»¶ï¼Œä¼šåœ¨ç»„ä»¶çš„ `props` å±æ€§ä¸Šæ·»åŠ  `navigator` å®ä¾‹å¯¹è±¡ï¼Œç”¨äºè®¿é—®å½“å‰æ‰€å¤„çš„ `Navigator` ç»„ä»¶å®ä¾‹ã€‚  
é€šè¿‡è¯¥å®ä¾‹ï¼Œå¯ä»¥è®¾ç½®å¯¼èˆªæ çŠ¶æ€ç­‰ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨è¯¥å®ä¾‹ä¸Šå¼€æ”¾äº†ä¸€ä¸ª `setRenderRightCompoent` æ–¹æ³•ï¼Œç”¨äºè®¾ç½® `RenderRightCompoent`ã€‚  
è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œ`RightComponent` å±æ€§ç©¶ç«Ÿéœ€ä¸éœ€è¦æ”¾åˆ° `route` é…ç½®ä¸Šå»ï¼Œä¾‹å¦‚  
```javascript
{
    key: '1',
    title: 'blabla',
    RenderRightCompoent: function () {}
}
```
ç”±äº `routes` å®šä¹‰ç»‘å®šåœ¨ `state` ä¸Šï¼Œæ›´æ–° `RenderRightCompoent`ï¼Œä¼šè§¦å‘æ–°ä¸€è½®çš„ `render`ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœ€æ–°çš„ `RightCompoent` ä¼šè¢«æ¸²æŸ“å‡ºæ¥ã€‚  
è™½ç„¶è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯æŠŠå‘ç”Ÿå˜æ›´çš„å±æ€§ååº”åˆ° `state` ä¸Šï¼Œä½†æ˜¯ï¼ŒæŠŠ `RenderRightCompoent` æ”¾ç½®åˆ°è·¯ç”±ä¸Šï¼Œæ•°æ®ç»“æ„ä¸Šå›æ›´åŠ æ¸…æ™°ã€‚  
æ— éœ€æ‹…å¿ƒ `route` å˜é‡å„å¤„ä¼ é€’ï¼Œä¼šå ç”¨æ›´å¤šå†…å­˜ï¼Œå› ä¸ºå¯¹äºå¯¹è±¡ï¼Œè¿™åªæ˜¯ä¸ªå¼•ç”¨è€Œå·²ã€‚  
æ‰€ä»¥è¿™é‡Œçš„åŸåˆ™æ˜¯ï¼Œéœ€è¦å®æ—¶æ›´æ–°çš„ç›¸å…³è”ç»„ä»¶ï¼Œæ”¾åˆ° `route`ï¼Œæ”¾åˆ° `state` é‡Œé¢å»ã€‚  
æ— éœ€å®æ—¶æ›´æ–°çš„ç»„ä»¶ï¼Œæ¯”å¦‚ä¸»è§†å›¾çš„å †æ ˆï¼Œå¯ä»¥è€ƒè™‘å•ç‹¬ç»´æŠ¤ä¸€ä¸ªæ•°ç»„ï¼Œè„±ç¦» `state`ï¼Œä»¥æé«˜æ€§èƒ½ã€‚  

è¿™é‡Œè¿˜æœ‰ä¸ª  `NavigationCardStack` æ¸²æŸ“æ—¶æœºçš„å°çŸ¥è¯†ï¼Œ`renderScene`  æ–¹æ³•æ˜¯æ¯” `header` æ¸²æŸ“å…ˆæ‰§è¡Œçš„ï¼ŒåŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `Main Scene` å†…ç»„ä»¶çš„  `componentWillMount` æ–¹æ³•ä¸Šï¼Œè®¾ç½®å¯¼èˆªæ å±æ€§ï¼Œä»¥æ­¤å‡å°‘é‡å¤æ¸²æŸ“ã€‚

## ç»„ä»¶ä¹‹é—´äº¤äº’é—®é¢˜ã€‚
åœ¨ç¤ºä¾‹é¡¹ç›®ä¸­ï¼Œ`RightComponent`ï¼Œæ˜¯ä¸€ä¸ªä¿å­˜æŒ‰é’®ï¼Œ`Man Scene` é‡Œé¢æœ‰ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œåªæœ‰å½“è¾“å…¥æ¡†æœ‰å€¼çš„æ—¶å€™ï¼Œä¿å­˜æŒ‰é’®ä¸ºå¯ç”¨çŠ¶æ€ã€‚  
ç¤ºä¾‹çš„å®ç°æ˜¯è¿”å›äº†ä¸€ä¸ª `RightComponent` çš„ `ref` å¼•ç”¨ï¼Œé€šè¿‡è°ƒç”¨åº”ç”¨çš„ `setState` æ¥æ›´æ–°æŒ‰é’®çŠ¶æ€ã€‚

è¿˜æœ‰ä¸€ç§å®ç°æ–¹å¼æ˜¯ï¼Œåˆ©ç”¨äº‹ä»¶æ¥ä¼ é€’çŠ¶æ€ï¼Œä¸åšå±•å¼€ï¼Œå› ä¸ºå…‰ `EventEmitter` æ¨¡å—é€‰å‹å°±å¯ä»¥å•ç‹¬å†™ä¸€å¤§ç¯‡æ–‡ç« ã€‚

æ›´é«˜çº§çš„å°è£…å®ç°ï¼Œå¯ä»¥è€ƒè™‘ `mobx`ï¼Œ`redux` ç­‰æ•°æ®æµç®¡ç†æ¶æ„ã€‚

## è§†å›¾æ¸²æŸ“é¢‘ç‡æ§åˆ¶
å¯ä»¥è€ƒè™‘åˆ©ç”¨é™æ€å®¹å™¨ï¼Œæ¥æ§åˆ¶æ¸²æŸ“é¢‘ç‡ï¼Œå½“å‰ç»„ä»¶çš„æ§åˆ¶ç­–ç•¥æ˜¯ï¼Œåªåœ¨ç»„ä»¶çŠ¶æ€ä»ï¼ˆunActive -> Activeï¼‰æ—¶æ¸²æŸ“ã€‚  
ğŸ‘‡ æ˜¯æˆ‘çš„å›ç­”ï¼Œå…³äºé‡å¤æ¸²æŸ“çš„é—®é¢˜  
[Component rendered twice when using NavigationExperimental (NavigationCardStack)](https://github.com/facebook/react-native/issues/10835#issuecomment-282565796)
